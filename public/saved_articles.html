<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saved Articles | News Digest</title>
  <link rel="stylesheet" href="/style.css">
  <!-- Supabase client -->

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <script src="/script.js" defer></script>
</head>
<body>
  <div class="title-box">
    <div class="title-side date" id="date"></div>
    <h1 class="main-title">Saved Articles</h1>
    <div class="title-side weather" id="weather"></div>
  </div>

  <nav class="nav-bar"> 
    <a href="/homepage.html">Home</a>
    <a href="/personalized.html">Personal Feed</a>
    <a href="/compare.html">Compare Coverage</a>
    <a href="/stocks.html">Stocks</a>
    <a href="/saved_articles.html">Saved Articles</a>
    <a href="/about.html">About</a>
  </nav>

  <section class="article-list" id="saved-articles">
    <p>Loading saved articles...</p>
  </section>

  <script>
    const supabase = createClient('https://tpzrjjybhkpfjjtczxyo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwenJqanliaGtwZmpqdGN6eHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyNTA4NzEsImV4cCI6MjA2MjgyNjg3MX0.t30PhGq4lwiCF7OMgWNvJQ1IUphSVFqU3m2sXzCvMtw');

    document.addEventListener("DOMContentLoaded", async () => {
      const dateEl = document.getElementById('date');
      const weatherEl = document.getElementById('weather');
      const savedArticlesBox = document.getElementById('saved-articles');

      // Load date
      const today = new Date();
      const dateOptions = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
      dateEl.textContent = today.toLocaleDateString(undefined, dateOptions);

      // Load weather
      fetch("https://api.open-meteo.com/v1/forecast?latitude=38.9&longitude=-77.03&current_weather=true")
        .then(res => res.json())
        .then(data => {
          const tempF = Math.round((data.current_weather.temperature * 9 / 5) + 32);
          weatherEl.textContent = `Washington, DC: ${tempF}Â°F`;
        });

      // Load saved articles from Supabase
      const { data: articles, error } = await client
        .from('saved_articles')
        .select('*')
        .order('created_at', { ascending: false });

      savedArticlesBox.innerHTML = '';

      if (error) {
        savedArticlesBox.innerHTML = '<p>Error loading saved articles.</p>';
        console.error(error);
        return;
      }

      if (!articles || articles.length === 0) {
        savedArticlesBox.innerHTML = '<p>No saved articles found.</p>';
        return;
      }

      articles.forEach(article => {
        const articleEl = document.createElement('div');
        articleEl.className = 'article';
        articleEl.innerHTML = `
          <h3><a href="${article.url}" target="_blank">${article.title}</a></h3>
          <p>${article.source}</p>
          <button class="remove-btn">Remove</button>
        `;

        articleEl.querySelector('.remove-btn').addEventListener('click', async () => {
          const confirmDelete = confirm("Are you sure you want to remove this article?");
          if (!confirmDelete) return;

          const { error: deleteError } = await client
            .from('saved_articles')
            .delete()
            .eq('url', article.url);

          if (deleteError) {
            alert('Error deleting article.');
            console.error(deleteError);
          } else {
            articleEl.remove();
          }
        });

        savedArticlesBox.appendChild(articleEl);
      });
    });
  </script>

</body>
</html>
